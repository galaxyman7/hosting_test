<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>P2P Hex Board</title>
<style>
  body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f9; }
  .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
  button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #fff; }
  button:hover { background: #eee; }
  textarea { width: 100%; height: 100px; margin: 10px 0; font-family: monospace; font-size: 11px; }
  #boardContainer { display: flex; justify-content: center; background: #ddd; padding: 10px; border-radius: 8px; }
  .edge { stroke: #999; stroke-width: 3; cursor: pointer; transition: 0.2s; }
  .edge:hover { stroke: #666; stroke-width: 5; }
  .edge.active { stroke: #ff4757; stroke-width: 6; }
  .hex-cell { fill: #fff; stroke: #eee; }
  #chat { height: 100px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
  .hidden { display: none; }
</style>
</head>
<body>

<h1>Hex Board & P2P Chat</h1>

<div id="setupMode">
  <button onclick="startHost()">Host a Room</button>
  <button onclick="startPlayer()">Join a Room</button>
</div>

<div id="hostPanel" class="panel hidden">
  <h2>Host Setup</h2>
  <p>1. Copy this Offer Code and send it to the player:</p>
  <textarea id="hostOffer" readonly></textarea>
  <p>2. Paste the Player's Answer Code here:</p>
  <textarea id="hostAnswerInput" placeholder="Paste answer here..."></textarea>
  <button onclick="hostAcceptAnswer()">Connect to Player</button>
  <div id="hostStatus">Status: Waiting for player...</div>
</div>

<div id="playerPanel" class="panel hidden">
  <h2>Player Setup</h2>
  <p>1. Paste the Host's Offer Code here:</p>
  <textarea id="playerOfferInput" placeholder="Paste offer here..."></textarea>
  <button onclick="playerCreateAnswer()">Generate Answer Code</button>
  <p>2. Copy this Answer Code and send it to the Host:</p>
  <textarea id="playerAnswerOutput" readonly></textarea>
  <div id="playerStatus">Status: Not connected</div>
</div>

<div id="gameArea" class="hidden">
  <div class="panel">
    <h3>Shared Board</h3>
    <div id="boardContainer">
      <svg id="hexSvg" width="400" height="400" viewBox="0 0 400 400"></svg>
    </div>
    <p id="hint" style="font-size: 12px; color: #666;"></p>
  </div>

  <div class="panel">
    <h3>Chat</h3>
    <div id="chat"></div>
    <input type="text" id="chatInput" placeholder="Type message..." style="width: 70%">
    <button onclick="sendChat()">Send</button>
  </div>
</div>

<script>
let pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
let dc;
let isHost = false;
const activeEdges = new Set();

// --- HOST LOGIC ---
async function startHost() {
  isHost = true;
  document.getElementById('setupMode').classList.add('hidden');
  document.getElementById('hostPanel').classList.remove('hidden');
  document.getElementById('gameArea').classList.remove('hidden');
  document.getElementById('hint').innerText = "Host: Click edges to bold them for everyone.";
  
  dc = pc.createDataChannel("chat");
  setupDataChannel(dc);

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  pc.onicecandidate = (e) => {
    if (!e.candidate) { // Wait for all ICE candidates
      document.getElementById('hostOffer').value = btoa(pc.localDescription.sdp);
    }
  };
  initBoard();
}

async function hostAcceptAnswer() {
  const ansSdp = atob(document.getElementById('hostAnswerInput').value.trim());
  await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: ansSdp }));
}

// --- PLAYER LOGIC ---
function startPlayer() {
  isHost = false;
  document.getElementById('setupMode').classList.add('hidden');
  document.getElementById('playerPanel').classList.remove('hidden');
  document.getElementById('gameArea').classList.remove('hidden');
  document.getElementById('hint').innerText = "Player: Wait for the host to update the board.";
  
  pc.ondatachannel = (e) => {
    dc = e.channel;
    setupDataChannel(dc);
  };
  initBoard();
}

async function playerCreateAnswer() {
  const offerSdp = atob(document.getElementById('playerOfferInput').value.trim());
  await pc.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: offerSdp }));
  
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  pc.onicecandidate = (e) => {
    if (!e.candidate) {
      document.getElementById('playerAnswerOutput').value = btoa(pc.localDescription.sdp);
    }
  };
}

// --- SHARED LOGIC ---
function setupDataChannel(channel) {
  channel.onopen = () => {
    const status = isHost ? 'hostStatus' : 'playerStatus';
    document.getElementById(status).innerText = "Status: Connected!";
    document.getElementById(status).style.color = "green";
  };
  channel.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.type === 'chat') addChat("Peer", data.msg);
    if (data.type === 'edge') toggleEdge(data.id);
  };
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value;
  if (dc && dc.readyState === "open") {
    dc.send(JSON.stringify({ type: 'chat', msg: msg }));
    addChat("Me", msg);
    input.value = "";
  }
}

function addChat(sender, msg) {
  const div = document.createElement('div');
  div.innerText = sender + ": " + msg;
  document.getElementById('chat').appendChild(div);
}

// --- BOARD LOGIC ---
function initBoard() {
  const svg = document.getElementById('hexSvg');
  const radius = 6, size = 20, centerX = 200, centerY = 200;

  for (let q = -5; q <= 5; q++) {
    for (let r = -5; r <= 5; r++) {
      if (Math.abs(q + r) <= 5) {
        const x = centerX + size * (3/2 * q);
        const y = centerY + size * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r);
        
        // Draw Hex
        const points = [];
        for (let i = 0; i < 6; i++) {
          const a = (Math.PI / 3) * i;
          points.push({ x: x + size * Math.cos(a), y: y + size * Math.sin(a) });
        }
        
        const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
        poly.setAttribute("points", points.map(p => p.x + "," + p.y).join(" "));
        poly.setAttribute("class", "hex-cell");
        svg.appendChild(poly);

        // Draw Edges
        for (let i = 0; i < 6; i++) {
          const p1 = points[i], p2 = points[(i + 1) % 6];
          const id = [Math.round(p1.x), Math.round(p1.y), Math.round(p2.x), Math.round(p2.y)].sort().join('_');
          if (!document.getElementById(id)) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", p1.x); line.setAttribute("y1", p1.y);
            line.setAttribute("x2", p2.x); line.setAttribute("y2", p2.y);
            line.setAttribute("class", "edge");
            line.setAttribute("id", id);
            line.onclick = () => {
              if (isHost && dc && dc.readyState === "open") {
                toggleEdge(id);
                dc.send(JSON.stringify({ type: 'edge', id: id }));
              }
            };
            svg.appendChild(line);
          }
        }
      }
    }
  }
}

function toggleEdge(id) {
  const el = document.getElementById(id);
  if (activeEdges.has(id)) {
    activeEdges.delete(id);
    el.classList.remove('active');
  } else {
    activeEdges.add(id);
    el.classList.add('active');
  }
}
</script>
</body>
</html>