<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hex Board Utility (P2P, No Servers)</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="app-header">
    <h1>Hex Board Utility</h1>
    <div id="teamBadge">Team: <span id="teamLabel">â€”</span></div>
    <div id="alertBadge">Alert: <span id="alertLabel">0</span></div>
  </header>

  <main class="layout">
    <section class="panel" id="joinPanel">
      <h2>Join</h2>
      <div class="role-row">
        <button id="gmRoleBtn">Join as GM</button>
        <button id="playerRoleBtn">Join as Player</button>
      </div>

      <div class="webrtc-row">
        <div class="webrtc-card" id="hostCard">
          <h3>Host (GM)</h3>
          <button id="hostBtn">Host</button>
          <button id="newOfferBtn" disabled>Create offer for new player</button>
          <div id="hostPeers"></div>
        </div>

        <div class="webrtc-card" id="playerCard">
          <h3>Player</h3>
          <button id="playerBtn">Player</button>
          <label>Paste host offer code:</label>
          <textarea id="offerInput" placeholder="Offer code"></textarea>
          <button id="createAnswerBtn" disabled>Create my answer</button>
          <label>Your answer code (copy to host):</label>
          <textarea id="answerOutput" readonly></textarea>
          <button id="copyAnswerBtn" disabled>Copy Answer</button>
          <button id="finalizeBtn" disabled>Finalize connection</button>
          <div id="playerStatus">Not connected.</div>
        </div>
      </div>
    </section>

    <section class="board-wrap">
      <svg id="boardSvg" class="board-svg" aria-label="Hex Board" role="img"></svg>
    </section>

    <section class="panel" id="controlsPanel">
      <h2>Controls</h2>

      <div id="gmControls" class="control-group" hidden>
        <div class="row">
          <button id="toggleWallModeBtn">Wall mode: Off</button>
          <button id="addNoteBtn">Add note</button>
          <label class="inline">Alert:
            <input id="alertRange" type="range" min="0" max="5" step="1" value="0" />
          </label>
          <button id="checkPlayersBtn">Check for players</button>
          <button id="saveBtn">Save</button>
          <input id="loadFile" type="file" accept="application/json" />
        </div>
      </div>

      <div id="playerControls" class="control-group" hidden>
        <div class="row">
          <button id="addCharacterBtn">Add character</button>
          <button id="toggleStealthBtn" disabled>Toggle stealth</button>
          <button id="changeColorBtn" disabled>Change color</button>
          <button id="placeTrapBtn">Place trap</button>
          <button id="checkTrapsBtn">Check for traps</button>
        </div>
      </div>

      <div class="row">
        <button id="sendBtn" disabled>Chat</button>
        <input id="chatInput" type="text" placeholder="Type a message..." />
      </div>

      <div id="chat" class="chat-box" aria-live="polite"></div>
    </section>
  </main>

  <template id="noteDialogTmpl">
    <dialog class="note-dialog">
      <h3>Note</h3>
      <div class="note-content"></div>
      <button class="closeNoteBtn">Close</button>
    </dialog>
  </template>

  <script type="module">
    import { Bus } from './js/bus.js';
    import { setupRTC } from './js/webrtc.js';
    import { State } from './js/state.js';
    import { setupBoard } from './js/board.js';
    import { setupUI } from './js/ui.js';
    import { Storage } from './js/storage.js';

    const bus = new Bus();
    const state = new State(bus);
    const storage = new Storage(bus, state);

    const rtc = setupRTC(bus, state);

    // Team selection
    const teamLabel = document.getElementById('teamLabel');
    const alertLabel = document.getElementById('alertLabel');

    let myTeam = null; // 'GM' | 'Players'
    const gmControls = document.getElementById('gmControls');
    const playerControls = document.getElementById('playerControls');

    const setTeam = (team) => {
      myTeam = team;
      teamLabel.textContent = team;
      gmControls.hidden = team !== 'GM';
      playerControls.hidden = team !== 'Players';
      bus.emit('team:set', { team });
    };

    document.getElementById('gmRoleBtn').onclick = () => setTeam('GM');
    document.getElementById('playerRoleBtn').onclick = () => setTeam('Players');

    // Board
    const svg = document.getElementById('boardSvg');
    const boardAPI = setupBoard(bus, state, svg);

    // UI
    setupUI(bus, state, boardAPI);

    // Alert badge updates
    bus.on('alert:updated', ({ alertLevel }) => {
      alertLabel.textContent = String(alertLevel);
    });

    // Initial board
    state.initializeBoard({ radius: 4 }); // default size; can be changed at runtime

    // Visibility enforcement after load
    bus.on('state:loaded', () => {
      bus.emit('visibility:refresh', { team: myTeam });
    });

    // Connect RTC UI elements
    rtc.attachUI({
      hostBtn: document.getElementById('hostBtn'),
      playerBtn: document.getElementById('playerBtn'),
      newOfferBtn: document.getElementById('newOfferBtn'),
      hostPeers: document.getElementById('hostPeers'),
      offerInput: document.getElementById('offerInput'),
      createAnswerBtn: document.getElementById('createAnswerBtn'),
      answerOutput: document.getElementById('answerOutput'),
      copyAnswerBtn: document.getElementById('copyAnswerBtn'),
      finalizeBtn: document.getElementById('finalizeBtn'),
      playerStatus: document.getElementById('playerStatus'),
      chatEl: document.getElementById('chat'),
      sendBtn: document.getElementById('sendBtn'),
      chatInput: document.getElementById('chatInput'),
    });
  </script>
</body>
</html>